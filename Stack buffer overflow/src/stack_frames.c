#define _GNU_SOURCE
#include <dlfcn.h>

#include <stdio.h>
#include <stdlib.h>

void *func_addr[64] = {0};

struct frame {
    struct frame *saved_ebp;
    void *saved_eip;
} __attribute__((packed));

void print_stack() {
    Dl_info dlinfo;
    int frame = 0;
    struct frame *fp;

    __asm__("movl %%ebp, %[fp]" : [ fp ] "=r"(fp));

    printf("--- stack ---\n");
    while (fp) {
        dladdr(fp->saved_eip, &dlinfo);
        printf("#%d %p (%s) saved_ebp = %p, saved_eip = %p\n", frame++, fp,
               dlinfo.dli_sname, fp->saved_ebp, fp->saved_eip);
        fp = fp->saved_ebp;
    }
}

void qux() {
    print_stack();
}
void moz() {
    qux();
}
void baz() {
    moz();
}
void bar() {
    baz();
}
void foo() {
    bar();
}

int main(int argc, char **argv) {
    foo();
}

