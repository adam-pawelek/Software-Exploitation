#include <getopt.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void usage(char *prog) {
    fprintf(stderr,
            "Usage: %s [-x] {-c TEXT | -f FILE}\n"
            "    -c TEXT  load buffer from command-line\n"
            "    -f FILE  load buffer from file\n",
            prog);
    exit(1);
}

int vulnerable(char *p, size_t n) {
    char buffer[128] = {0};
    memcpy(buffer, p, n);
    return 2;
}

int main(int argc, char **argv) {
    char buffer[4096] = {0};
    size_t buffer_len = 0;

    int opt;
    while ((opt = getopt(argc, argv, "hf:c:")) != -1) {
        switch (opt) {
        case 'c': {
            buffer_len = strlen(optarg);
            printf("argument length is %zu bytes\n", buffer_len);
            if (memcpy(buffer, optarg, buffer_len) == 0) {
                perror("memcpy");
                exit(1);
            }
        } break;
        case 'f': {
            FILE *fp = stdin;
            if (strcmp(optarg, "-") && (fp = fopen(optarg, "r")) == 0) {
                perror("fopen");
                exit(1);
            }
            buffer_len = fread(buffer, 1, sizeof(buffer), fp);
            if (ferror(fp)) {
                perror("fread");
                exit(1);
            }
            printf("input length is %zu bytes\n", buffer_len);
        } break;
        default:
            usage(argv[0]);
        }
    }

    return vulnerable(buffer, buffer_len);
}
